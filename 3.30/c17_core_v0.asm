00000000000i[     ] Bochs x86 Emulator 2.4.5
00000000000i[     ]   Build from CVS snapshot, on April 25, 2010
00000000000i[     ] System configuration
00000000000i[     ]   processors: 1 (cores=1, HT threads=1)
00000000000i[     ]   A20 line support: yes
00000000000i[     ] CPU configuration
00000000000i[     ]   level: 6
00000000000i[     ]   SMP support: no
00000000000i[     ]   APIC support: yes
00000000000i[     ]   FPU support: yes
00000000000i[     ]   MMX support: yes
00000000000i[     ]   3dnow! support: no
00000000000i[     ]   SEP support: yes
00000000000i[     ]   SSE support: sse2
00000000000i[     ]   XSAVE support: no
00000000000i[     ]   AES support: no
00000000000i[     ]   MOVBE support: no
00000000000i[     ]   x86-64 support: no
00000000000i[     ]   MWAIT support: no
00000000000i[     ]   VMX support: no
00000000000i[     ] Optimization configuration
00000000000i[     ]   RepeatSpeedups support: yes
00000000000i[     ]   Trace cache support: yes
00000000000i[     ]   Fast function calls: yes
00000000000i[     ] Devices configuration
00000000000i[     ]   ACPI support: no
00000000000i[     ]   NE2000 support: no
00000000000i[     ]   PCI support: no, enabled=no
00000000000i[     ]   SB16 support: no
00000000000i[     ]   USB support: no
00000000000i[     ]   VGA extension support: vbe 
00000000000i[MEM0 ] allocated memory at 0x7f2c23417010. after alignment, vector=0x7f2c23418000
00000000000i[MEM0 ] 128.00MB
00000000000i[MEM0 ] mem block size = 0x00100000, blocks=128
00000000000i[MEM0 ] rom at 0xfffe0000/131072 ('/usr/local/share/bochs/gdb/share/bochs/BIOS-bochs-latest')
00000000000i[MEM0 ] rom at 0xc0000/41472 ('/usr/local/share/bochs/gdb/share/bochs/VGABIOS-lgpl-latest')
00000000000i[CMOS ] Using local time for initial clock
00000000000i[CMOS ] Setting initial clock to: Mon Apr 22 10:44:49 2019 (time0=1555901089)
00000000000i[DMA  ] channel 4 used by cascade
00000000000i[DMA  ] channel 2 used by Floppy Drive
00000000000i[FDD  ] tried to open 'fd0' read/write: No such file or directory
00000000000i[FDD  ] tried to open 'fd0' read only: No such file or directory
00000000000i[VGA  ] interval=50000
00000000000i[MEM0 ] Register memory access handlers: 0x000a0000 - 0x000bffff
00000000000i[XGUI ] test_alloc_colors: 16 colors available out of 16 colors tried
00000000000i[XGUI ] font 8 wide x 16 high, display depth = 24
00000000000i[MEM0 ] Register memory access handlers: 0xe0000000 - 0xe0ffffff
00000000000i[VGA  ] VBE Bochs Display Extension Enabled
00000000000i[     ] init_dev of 'unmapped' plugin device by virtual method
00000000000i[     ] init_dev of 'biosdev' plugin device by virtual method
00000000000i[     ] init_dev of 'speaker' plugin device by virtual method
00000000000i[SPEAK] Failed to open /dev/console: No such file or directory
00000000000i[SPEAK] Deactivating beep on console
00000000000i[     ] init_dev of 'extfpuirq' plugin device by virtual method
00000000000i[     ] init_dev of 'iodebug' plugin device by virtual method
00000000000i[     ] init_dev of 'ioapic' plugin device by virtual method
00000000000i[IOAP ] initializing I/O APIC
00000000000i[MEM0 ] Register memory access handlers: 0xfec00000 - 0xfec00fff
00000000000i[     ] init_dev of 'keyboard' plugin device by virtual method
00000000000i[KBD  ] will paste characters every 1000 keyboard ticks
00000000000i[     ] init_dev of 'harddrv' plugin device by virtual method
00000000000i[HD   ] HD on ata0-0: 'h.img' 'flat' mode 
00000000000i[HD   ] translation on ata0-0 set to 'large'
00000000000i[HD   ] Using boot sequence disk, none, none
00000000000i[HD   ] Floppy boot signature check is enabled
00000000000i[     ] init_dev of 'serial' plugin device by virtual method
00000000000i[SER  ] com1 at 0x03f8 irq 4
00000000000i[     ] init_dev of 'parallel' plugin device by virtual method
00000000000i[PAR  ] parallel port 1 at 0x0378 irq 7
00000000000i[     ] register state of 'unmapped' plugin device by virtual method
00000000000i[     ] register state of 'biosdev' plugin device by virtual method
00000000000i[     ] register state of 'speaker' plugin device by virtual method
00000000000i[     ] register state of 'extfpuirq' plugin device by virtual method
00000000000i[     ] register state of 'iodebug' plugin device by virtual method
00000000000i[     ] register state of 'ioapic' plugin device by virtual method
00000000000i[     ] register state of 'keyboard' plugin device by virtual method
00000000000i[     ] register state of 'harddrv' plugin device by virtual method
00000000000i[     ] register state of 'serial' plugin device by virtual method
00000000000i[     ] register state of 'parallel' plugin device by virtual method
00000000000i[SYS  ] bx_pc_system_c::Reset(HARDWARE) called
00000000000i[CPU0 ] cpu hardware reset
00000000000i[APIC0] allocate APIC id=0 (MMIO enabled) to 0xfee00000
00000000000i[CPU0 ] CPUID[0x00000000]: 00000003 756e6547 6c65746e 49656e69
00000000000i[CPU0 ] CPUID[0x00000001]: 00000f00 00000800 00000000 078bfbff
00000000000i[CPU0 ] CPUID[0x00000002]: 00410601 00000000 00000000 00000000
00000000000i[CPU0 ] CPUID[0x00000003]: 00000000 00000000 00000000 00000000
00000000000i[CPU0 ] CPUID[0x00000004]: 00000000 00000000 00000000 00000000
00000000000i[CPU0 ] CPUID[0x80000000]: 80000004 00000000 00000000 00000000
00000000000i[CPU0 ] CPUID[0x80000001]: 00000000 00000000 00000000 00000000
00000000000i[CPU0 ] CPUID[0x80000002]: 20202020 20202020 20202020 6e492020
00000000000i[CPU0 ] CPUID[0x80000003]: 286c6574 50202952 69746e65 52286d75
00000000000i[CPU0 ] CPUID[0x80000004]: 20342029 20555043 20202020 00202020
00000000000i[     ] reset of 'unmapped' plugin device by virtual method
00000000000i[     ] reset of 'biosdev' plugin device by virtual method
00000000000i[     ] reset of 'speaker' plugin device by virtual method
00000000000i[     ] reset of 'extfpuirq' plugin device by virtual method
00000000000i[     ] reset of 'iodebug' plugin device by virtual method
00000000000i[     ] reset of 'ioapic' plugin device by virtual method
00000000000i[     ] reset of 'keyboard' plugin device by virtual method
00000000000i[     ] reset of 'harddrv' plugin device by virtual method
00000000000i[     ] reset of 'serial' plugin device by virtual method
00000000000i[     ] reset of 'parallel' plugin device by virtual method
00000000000i[XGUI ] [x] Mouse off
00000004662i[BIOS ] $Revision: 13073 $ $Date: 2017-02-16 22:43:52 +0100 (Do, 16. Feb 2017) $
00000318065i[KBD  ] reset-disable command received
00000320796i[BIOS ] Starting rombios32
00000321234i[BIOS ] Shutdown flag 0
00000321817i[BIOS ] ram_size=0x08000000
00000322260i[BIOS ] ram_end=128MB
00000362774i[BIOS ] Found 1 cpu(s)
00000376358i[BIOS ] bios_table_addr: 0x000f9cd8 end=0x000fcc00
00000394815i[BIOS ] bios_table_cur_addr: 0x000f9cd8
00000522432i[VBIOS] VGABios $Id: vgabios.c,v 1.76 2013/02/10 08:07:03 vruppert Exp $
00000522503i[VGA  ] VBE known Display Interface b0c0
00000522535i[VGA  ] VBE known Display Interface b0c5
00000525460i[VBIOS] VBE Bios $Id: vbe.c,v 1.65 2014/07/08 18:02:25 vruppert Exp $
00000600000i[XGUI ] charmap update. Font Height is 16
00000869666i[BIOS ] ata0-0: PCHS=2/16/64 translation=large LCHS=2/16/64
00004316728i[BIOS ] IDE time out
00016286282i[BIOS ] Booting from 0000:7c00
00016400000i[XGUI ] charmap update. Font Height is 16
00108344348i[     ] dbg: Quit
00108344348i[CPU0 ] CPU is in protected mode (active)
00108344348i[CPU0 ] CS.d_b = 32 bit
00108344348i[CPU0 ] SS.d_b = 32 bit
00108344348i[CPU0 ] | EAX=00000000  EBX=00000000  ECX=0000002f  EDX=000003d5
00108344348i[CPU0 ] | ESP=00003fd0  EBP=00000000  ESI=00000000  EDI=00000000
00108344348i[CPU0 ] | IOPL=0 id vip vif ac vm rf nt of df if tf sf zf af pf cf
00108344348i[CPU0 ] | SEG selector     base    limit G D
00108344348i[CPU0 ] | SEG sltr(index|ti|rpl)     base    limit G D
00108344348i[CPU0 ] |  CS:0008( 0001| 0|  0) 00000000 ffffffff 1 1
00108344348i[CPU0 ] |  DS:000f( 0001| 1|  3) 00000000 ffffffff 1 1
00108344348i[CPU0 ] |  SS:0014( 0002| 1|  0) 00000000 ffffffff 1 1
00108344348i[CPU0 ] |  ES:000f( 0001| 1|  3) 00000000 ffffffff 1 1
00108344348i[CPU0 ] |  FS:000f( 0001| 1|  3) 00000000 ffffffff 1 1
00108344348i[CPU0 ] |  GS:000f( 0001| 1|  3) 00000000 ffffffff 1 1
00108344348i[CPU0 ] | EIP=8004005c (8004005c)
00108344348i[CPU0 ] | CR0=0xe0000019 CR2=0x00000000
00108344348i[CPU0 ] | CR3=0x00105000 CR4=0x00000000
00108344348i[CMOS ] Last time is 1555901116 (Mon Apr 22 10:45:16 2019)
00108344348i[XGUI ] Exit
00108344348i[CTRL ] quit_sim called with exit code 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Ğ¶ÔÓ¦µÄÒ³±í
          
         ;´´½¨¸ÃÏßĞÔµØÖ·Ëù¶ÔÓ¦µÄÒ³±í 
         call allocate_a_4k_page            ;·ÖÅäÒ»¸öÒ³×öÎªÒ³±í 
         or eax,0x00000007
         mov [esi],eax                      ;ÔÚÒ³Ä¿Â¼ÖĞµÇ¼Ç¸ÃÒ³±í
          
  .b1:
         ;¿ªÊ¼·ÃÎÊ¸ÃÏßĞÔµØÖ·Ëù¶ÔÓ¦µÄÒ³±í 
         mov esi,ebx
         shr esi,10
         and esi,0x003ff000                 ;»òÕß0xfffff000£¬Òò¸ß10Î»ÊÇÁã 
         or esi,0xffc00000                  ;µÃµ½¸ÃÒ³±íµÄÏßĞÔµØÖ·
         
         ;µÃµ½¸ÃÏßĞÔµØÖ·ÔÚÒ³±íÄÚµÄ¶ÔÓ¦ÌõÄ¿£¨Ò³±íÏî£© 
         and ebx,0x003ff000
         shr ebx,10                         ;Ïàµ±ÓÚÓÒÒÆ12Î»£¬ÔÙ³ËÒÔ4
         or esi,ebx                         ;Ò³±íÏîµÄÏßĞÔµØÖ· 
         call allocate_a_4k_page            ;·ÖÅäÒ»¸öÒ³£¬Õâ²ÅÊÇÒª°²×°µÄÒ³
         or eax,0x00000007
         mov [esi],eax 
          
         pop esi
         pop ebx
         pop eax
         
         retf  

;-------------------------------------------------------------------------------
create_copy_cur_pdir:                       ;´´½¨ĞÂÒ³Ä¿Â¼£¬²¢¸´ÖÆµ±Ç°Ò³Ä¿Â¼ÄÚÈİ
                                            ;ÊäÈë£ºÎŞ
                                            ;Êä³ö£ºEAX=ĞÂÒ³Ä¿Â¼µÄÎïÀíµØÖ· 
         push esi
         push edi
         push ebx
         push ecx
         
         call allocate_a_4k_page            
         mov ebx,eax
         or ebx,0x00000007
         mov [0xfffffff8],ebx

         invlpg [0xfffffff8]

         mov esi,0xfffff000                 ;ESI->µ±Ç°Ò³Ä¿Â¼µÄÏßĞÔµØÖ·
         mov edi,0xffffe000                 ;EDI->ĞÂÒ³Ä¿Â¼µÄÏßĞÔµØÖ·
         mov ecx,1024                       ;ECX=Òª¸´ÖÆµÄÄ¿Â¼ÏîÊı
         cld
         repe movsd 
         
         pop ecx
         pop ebx
         pop edi
         pop esi
         
         retf
         
;-------------------------------------------------------------------------------
general_interrupt_handler:                  ;Í¨ÓÃµÄÖĞ¶Ï´¦Àí¹ı³Ì
         push eax
          
         mov al,0x20                        ;ÖĞ¶Ï½áÊøÃüÁîEOI 
         out 0xa0,al                        ;Ïò´ÓÆ¬·¢ËÍ 
         out 0x20,al                        ;ÏòÖ÷Æ¬·¢ËÍ
         
         pop eax
          
         iretd

;-------------------------------------------------------------------------------
general_exception_handler:                  ;Í¨ÓÃµÄÒì³£´¦Àí¹ı³Ì
       ;   mov ebx,excep_msg
       ;   call flat_4gb_code_seg_sel:put_string ; tag by me
         
         hlt

;-------------------------------------------------------------------------------
rtm_0x70_interrupt_handle:                  ;ÊµÊ±Ê±ÖÓÖĞ¶Ï´¦Àí¹ı³Ì

         pushad

         mov al,0x20                        ;ÖĞ¶Ï½áÊøÃüÁîEOI
         out 0xa0,al                        ;Ïò8259A´ÓÆ¬·¢ËÍ
         out 0x20,al                        ;Ïò8259AÖ÷Æ¬·¢ËÍ

         mov al,0x0c                        ;¼Ä´æÆ÷CµÄË÷Òı¡£ÇÒ¿ª·ÅNMI
         out 0x70,al
         in al,0x71                         ;¶ÁÒ»ÏÂRTCµÄ¼Ä´æÆ÷C£¬·ñÔòÖ»·¢ÉúÒ»´ÎÖĞ¶Ï
                                            ;´Ë´¦²»¿¼ÂÇÄÖÖÓºÍÖÜÆÚĞÔÖĞ¶ÏµÄÇé¿ö
         ;ÕÒµ±Ç°ÈÎÎñ£¨×´Ì¬ÎªÃ¦µÄÈÎÎñ£©ÔÚÁ´±íÖĞµÄÎ»ÖÃ
         mov eax,tcb_chain                  
  .b0:                                      ;EAX=Á´±íÍ·»òµ±Ç°TCBÏßĞÔµØÖ·
         mov ebx,[eax]                      ;EBX=ÏÂÒ»¸öTCBÏßĞÔµØÖ·
         or ebx,ebx
         jz .irtn                           ;Á´±íÎª¿Õ£¬»òÒÑµ½Ä©Î²£¬´ÓÖĞ¶Ï·µ»Ø
         cmp word [ebx+0x04],0xffff         ;ÊÇÃ¦ÈÎÎñ£¨µ±Ç°ÈÎÎñ£©£¿
         je .b1
         mov eax,ebx                        ;¶¨Î»µ½ÏÂÒ»¸öTCB£¨µÄÏßĞÔµØÖ·£©
         jmp .b0         

         ;½«µ±Ç°ÎªÃ¦µÄÈÎÎñÒÆµ½Á´Î²
  .b1:
         mov ecx,[ebx]                      ;ÏÂÓÎTCBµÄÏßĞÔµØÖ·
         mov [eax],ecx                      ;½«µ±Ç°ÈÎÎñ´ÓÁ´ÖĞ²ğ³ı

  .b2:                                      ;´ËÊ±£¬EBX=µ±Ç°ÈÎÎñµÄÏßĞÔµØÖ·
         mov edx,[eax]
         or edx,edx                         ;ÒÑµ½Á´±íÎ²¶Ë£¿
         jz .b3
         mov eax,edx
         jmp .b2

  .b3:
         mov [eax],ebx                      ;½«Ã¦ÈÎÎñµÄTCB¹ÒÔÚÁ´±íÎ²¶Ë
         mov dword [ebx],0x00000000         ;½«Ã¦ÈÎÎñµÄTCB±ê¼ÇÎªÁ´Î²

         ;´ÓÁ´Ê×ËÑË÷µÚÒ»¸ö¿ÕÏĞÈÎÎñ
         mov eax,tcb_chain
  .b4:
         mov eax,[eax]
         or eax,eax                         ;ÒÑµ½Á´Î²£¨Î´·¢ÏÖ¿ÕÏĞÈÎÎñ£©
         jz .irtn                           ;Î´·¢ÏÖ¿ÕÏĞÈÎÎñ£¬´ÓÖĞ¶Ï·µ»Ø
         cmp word [eax+0x04],0x0000         ;ÊÇ¿ÕÏĞÈÎÎñ£¿
         jnz .b4

         ;½«¿ÕÏĞÈÎÎñºÍµ±Ç°ÈÎÎñµÄ×´Ì¬¶¼È¡·´
         not word [eax+0x04]                ;ÉèÖÃ¿ÕÏĞÈÎÎñµÄ×´Ì¬ÎªÃ¦
         not word [ebx+0x04]                ;ÉèÖÃµ±Ç°ÈÎÎñ£¨Ã¦£©µÄ×´Ì¬Îª¿ÕÏĞ
         jmp far [eax+0x14]                 ;ÈÎÎñ×ª»»

  .irtn:
         popad

         iretd

;-------------------------------------------------------------------------------
terminate_current_task:                     ;ÖÕÖ¹µ±Ç°ÈÎÎñ
                                            ;×¢Òâ£¬Ö´ĞĞ´ËÀı³ÌÊ±£¬µ±Ç°ÈÎÎñÈÔÔÚ
                                            ;ÔËĞĞÖĞ¡£´ËÀı³ÌÆäÊµÒ²ÊÇµ±Ç°ÈÎÎñµÄ
                                            ;Ò»²¿·Ö 
         ;ÕÒµ±Ç°ÈÎÎñ£¨×´Ì¬ÎªÃ¦µÄÈÎÎñ£©ÔÚÁ´±íÖĞµÄÎ»ÖÃ
         mov eax,tcb_chain
  .b0:                                      ;EAX=Á´±íÍ·»òµ±Ç°TCBÏßĞÔµØÖ·
         mov ebx,[eax]                      ;EBX=ÏÂÒ»¸öTCBÏßĞÔµØÖ·
         cmp word [ebx+0x04],0xffff         ;ÊÇÃ¦ÈÎÎñ£¨µ±Ç°ÈÎÎñ£©£¿
         je .b1
         mov eax,ebx                        ;¶¨Î»µ½ÏÂÒ»¸öTCB£¨µÄÏßĞÔµØÖ·£©
         jmp .b0
         
  .b1:
         mov word [ebx+0x04],0x3333         ;ĞŞ¸Äµ±Ç°ÈÎÎñµÄ×´Ì¬Îª¡°ÍË³ö¡±
         
  .b2:
         hlt                                ;Í£»ú£¬µÈ´ı³ÌĞò¹ÜÀíÆ÷»Ö¸´ÔËĞĞÊ±£¬
                                            ;½«Æä»ØÊÕ 
         jmp .b2 

;------------------------------------------------------------------------------- 
         pgdt             dw  0             ;ÓÃÓÚÉèÖÃºÍĞŞ¸ÄGDT 
                          dd  0

         pidt             dw  0
                          dd  0
                          
         ;ÈÎÎñ¿ØÖÆ¿éÁ´
         tcb_chain        dd  0 

         core_tcb   times  32  db 0         ;ÄÚºË£¨³ÌĞò¹ÜÀíÆ÷£©µÄTCB

         page_bit_map     db  0xff,0xff,0xff,0xff,0xff,0xff,0x55,0x55
                          db  0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
                          db  0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
                          db  0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
                          db  0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55
                          db  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
                          db  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
                          db  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
         page_map_len     equ $-page_bit_map
                          
         ;·ûºÅµØÖ·¼ìË÷±í
         salt:
         salt_0           db  '@PrintChar'      ; add my me
                     times 256-($-salt_0) db 0
                          dd  put_char
                          dw  flat_4gb_code_seg_sel

         salt_1           db  '@PrintString'
                     times 256-($-salt_1) db 0
                          dd  put_string
                          dw  flat_4gb_code_seg_sel

         salt_2           db  '@ReadDiskData'
                     times 256-($-salt_2) db 0
                          dd  read_hard_disk_0
                          dw  flat_4gb_code_seg_sel

         salt_3           db  '@PrintDwordAsHexString'
                     times 256-($-salt_3) db 0
                          dd  put_hex_dword
                          dw  flat_4gb_code_seg_sel

         salt_4           db  '@TerminateProgram'
                     times 256-($-salt_4) db 0
                          dd  terminate_current_task
                          dw  flat_4gb_code_seg_sel

         salt_item_len   equ $-salt_4
         salt_items      equ ($-salt)/salt_item_len

         excep_msg        db  '********Exception encounted********',0

         message_0        db  '  Working in system core with protection '
                          db  'and paging are all enabled.System core is mapped '
                          db  'to address 0x80000000.',0x0d,0x0a,0

         message_1        db  '  System wide CALL-GATE mounted.',0x0d,0x0a,0
         
         message_3        db  '********No more pages********',0
         
         core_msg0        db  '  System core task running!',0x0d,0x0a,0
         
         bin_hex          db '0123456789ABCDEF'
                                            ;put_hex_dword×Ó¹ı³ÌÓÃµÄ²éÕÒ±í 

         core_buf   times 512 db 0          ;ÄÚºËÓÃµÄ»º³åÇø

         cpu_brnd0        db 0x0d,0x0a,'  ',0
         cpu_brand  times 52 db 0
         cpu_brnd1        db 0x0d,0x0a,0x0d,0x0a,0

;-------------------------------------------------------------------------------
fill_descriptor_in_ldt:                     ;ÔÚLDTÄÚ°²×°Ò»¸öĞÂµÄÃèÊö·û
                                            ;ÊäÈë£ºEDX:EAX=ÃèÊö·û
                                            ;          EBX=TCB»ùµØÖ·
                                            ;Êä³ö£ºCX=ÃèÊö·ûµÄÑ¡Ôñ×Ó
         push eax
         push edx
         push edi

         mov edi,[ebx+0x0c]                 ;»ñµÃLDT»ùµØÖ·
         
         xor ecx,ecx
         mov cx,[ebx+0x0a]                  ;»ñµÃLDT½çÏŞ
         inc cx                             ;LDTµÄ×Ü×Ö½ÚÊı£¬¼´ĞÂÃèÊö·ûÆ«ÒÆµØÖ·
         
         mov [edi+ecx+0x00],eax
         mov [edi+ecx+0x04],edx             ;°²×°ÃèÊö·û

         add cx,8                           
         dec cx                             ;µÃµ½ĞÂµÄLDT½çÏŞÖµ 

         mov [ebx+0x0a],cx                  ;¸üĞÂLDT½çÏŞÖµµ½TCB

         mov ax,cx
         xor dx,dx
         mov cx,8
         div cx
         
         mov cx,ax
         shl cx,3                           ;×óÒÆ3Î»£¬²¢ÇÒ
         or cx,0000_0000_0000_0100B         ;Ê¹TIÎ»=1£¬Ö¸ÏòLDT£¬×îºóÊ¹RPL=00 

         pop edi
         pop edx
         pop eax
     
         ret
      
;-------------------------------------------------------------------------------
load_relocate_program:                      ;¼ÓÔØ²¢ÖØ¶¨Î»ÓÃ»§³ÌĞò
                                            ;ÊäÈë: PUSH Âß¼­ÉÈÇøºÅ
                                            ;      PUSH ÈÎÎñ¿ØÖÆ¿é»ùµØÖ·
                                            ;Êä³ö£ºÎŞ 
         pushad
      
         mov ebp,esp                        ;Îª·ÃÎÊÍ¨¹ı¶ÑÕ»´«µİµÄ²ÎÊı×ö×¼±¸
      
         ;Çå¿Õµ±Ç°Ò³Ä¿Â¼µÄÇ°°ë²¿·Ö£¨¶ÔÓ¦µÍ2GBµÄ¾Ö²¿µØÖ·¿Õ¼ä£© 
         mov ebx,0xfffff000
         xor esi,esi
  .b1:
         mov dword [ebx+esi*4],0x00000000
         inc esi
         cmp esi,512
         jl .b1

         mov eax,cr3
         mov cr3,eax                        ;Ë¢ĞÂTLB 
         
         ;ÒÔÏÂ¿ªÊ¼·ÖÅäÄÚ´æ²¢¼ÓÔØÓÃ»§³ÌĞò
         mov eax,[ebp+40]                   ;´Ó¶ÑÕ»ÖĞÈ¡³öÓÃ»§³ÌĞòÆğÊ¼ÉÈÇøºÅ
         mov ebx,core_buf                   ;¶ÁÈ¡³ÌĞòÍ·²¿Êı¾İ
         call flat_4gb_code_seg_sel:read_hard_disk_0

         ;ÒÔÏÂÅĞ¶ÏÕû¸ö³ÌĞòÓĞ¶à´ó
         mov eax,[core_buf]                 ;³ÌĞò³ß´ç
         mov ebx,eax
         and ebx,0xfffff000                 ;Ê¹Ö®4KB¶ÔÆë 
         add ebx,0x1000                        
         test eax,0x00000fff                ;³ÌĞòµÄ´óĞ¡ÕıºÃÊÇ4KBµÄ±¶ÊıÂğ? 
         cmovnz eax,ebx                     ;²»ÊÇ¡£Ê¹ÓÃ´ÕÕûµÄ½á¹û

         mov ecx,eax
         shr ecx,12                         ;³ÌĞòÕ¼ÓÃµÄ×Ü4KBÒ³Êı 
         
         mov eax,[ebp+40]                   ;ÆğÊ¼ÉÈÇøºÅ
         mov esi,[ebp+36]                   ;´Ó¶ÑÕ»ÖĞÈ¡µÃTCBµÄ»ùµØÖ·
  .b2:
         alloc_user_linear                  ;ºê£ºÔÚÓÃ»§ÈÎÎñµØÖ·¿Õ¼äÉÏ·ÖÅäÄÚ´æ 
         
         push ecx
         mov ecx,8
  .b3:
         call flat_4gb_code_seg_sel:read_hard_disk_0               
         inc eax
         loop .b3

         pop ecx
         loop .b2

         ;ÔÚÄÚºËµØÖ·¿Õ¼äÄÚ´´½¨ÓÃ»§ÈÎÎñµÄTSS
         alloc_core_linear                  ;ºê£ºÔÚÄÚºËµÄµØÖ·¿Õ¼äÉÏ·ÖÅäÄÚ´æ
                                            ;ÓÃ»§ÈÎÎñµÄTSS±ØĞëÔÚÈ«¾Ö¿Õ¼äÉÏ·ÖÅä 
         
         mov [esi+0x14],ebx                 ;ÔÚTCBÖĞÌîĞ´TSSµÄÏßĞÔµØÖ· 
         mov word [esi+0x12],103            ;ÔÚTCBÖĞÌîĞ´TSSµÄ½çÏŞÖµ 
          
         ;ÔÚÓÃ»§ÈÎÎñµÄ¾Ö²¿µØÖ·¿Õ¼äÄÚ´´½¨LDT 
         alloc_user_linear                  ;ºê£ºÔÚÓÃ»§ÈÎÎñµØÖ·¿Õ¼äÉÏ·ÖÅäÄÚ´æ

         mov [esi+0x0c],ebx                 ;ÌîĞ´LDTÏßĞÔµØÖ·µ½TCBÖĞ 

         ;½¨Á¢³ÌĞò´úÂë¶ÎÃèÊö·û
         mov eax,0x00000000
         mov ebx,0x000fffff                 
         mov ecx,0x00c0f800                 ;4KBÁ£¶ÈµÄ´úÂë¶ÎÃèÊö·û£¬ÌØÈ¨¼¶3
         call flat_4gb_code_seg_sel:make_seg_descriptor
         mov ebx,esi                        ;TCBµÄ»ùµØÖ·
         call fill_descriptor_in_ldt
         or cx,0000_0000_0000_0011B         ;ÉèÖÃÑ¡Ôñ×ÓµÄÌØÈ¨¼¶Îª3
         
         mov ebx,[esi+0x14]                 ;´ÓTCBÖĞ»ñÈ¡TSSµÄÏßĞÔµØÖ·
         mov [ebx+76],cx                    ;ÌîĞ´TSSµÄCSÓò 

         ;½¨Á¢³ÌĞòÊı¾İ¶ÎÃèÊö·û
         mov eax,0x00000000
         mov ebx,0x000fffff                 
         mov ecx,0x00c0f200                 ;4KBÁ£¶ÈµÄÊı¾İ¶ÎÃèÊö·û£¬ÌØÈ¨¼¶3
         call flat_4gb_code_seg_sel:make_seg_descriptor
         mov ebx,esi                        ;TCBµÄ»ùµØÖ·
         call fill_descriptor_in_ldt
         or cx,0000_0000_0000_0011B         ;ÉèÖÃÑ¡Ôñ×ÓµÄÌØÈ¨¼¶Îª3
         
         mov ebx,[esi+0x14]                 ;´ÓTCBÖĞ»ñÈ¡TSSµÄÏßĞÔµØÖ·
         mov [ebx+84],cx                    ;ÌîĞ´TSSµÄDSÓò 
         mov [ebx+72],cx                    ;ÌîĞ´TSSµÄESÓò
         mov [ebx+88],cx                    ;ÌîĞ´TSSµÄFSÓò
         mov [ebx+92],cx                    ;ÌîĞ´TSSµÄGSÓò
         
         ;½«Êı¾İ¶Î×÷ÎªÓÃ»§ÈÎÎñµÄ3ÌØÈ¨¼¶¹ÌÓĞ¶ÑÕ» 
         alloc_user_linear                  ;ºê£ºÔÚÓÃ»§ÈÎÎñµØÖ·¿Õ¼äÉÏ·ÖÅäÄÚ´æ
         
         mov ebx,[esi+0x14]                 ;´ÓTCBÖĞ»ñÈ¡TSSµÄÏßĞÔµØÖ·
         mov [ebx+80],cx                    ;ÌîĞ´TSSµÄSSÓò
         mov edx,[esi+0x06]                 ;¶ÑÕ»µÄ¸ß¶ËÏßĞÔµØÖ· 
         mov [ebx+56],edx                   ;ÌîĞ´TSSµÄESPÓò 

         ;ÔÚÓÃ»§ÈÎÎñµÄ¾Ö²¿µØÖ·¿Õ¼äÄÚ´´½¨0ÌØÈ¨¼¶¶ÑÕ»
         alloc_user_linear                  ;ºê£ºÔÚÓÃ»§ÈÎÎñµØÖ·¿Õ¼äÉÏ·ÖÅäÄÚ´æ

         mov eax,0x00000000
         mov ebx,0x000fffff
         mov ecx,0x00c09200                 ;4KBÁ£¶ÈµÄ¶ÑÕ»¶ÎÃèÊö·û£¬ÌØÈ¨¼¶0
         call flat_4gb_code_seg_sel:make_seg_descriptor
         mov ebx,esi                        ;TCBµÄ»ùµØÖ·
         call fill_descriptor_in_ldt
         or cx,0000_0000_0000_0000B         ;ÉèÖÃÑ¡Ôñ×ÓµÄÌØÈ¨¼¶Îª0

         mov ebx,[esi+0x14]                 ;´ÓTCBÖĞ»ñÈ¡TSSµÄÏßĞÔµØÖ·
         mov [ebx+8],cx                     ;ÌîĞ´TSSµÄSS0Óò
         mov edx,[esi+0x06]                 ;¶ÑÕ»µÄ¸ß¶ËÏßĞÔµØÖ·
         mov [ebx+4],edx                    ;ÌîĞ´TSSµÄESP0Óò 

         ;ÔÚÓÃ»§ÈÎÎñµÄ¾Ö²¿µØÖ·¿Õ¼äÄÚ´´½¨1ÌØÈ¨¼¶¶ÑÕ»
         alloc_user_linear                  ;ºê£ºÔÚÓÃ»§ÈÎÎñµØÖ·¿Õ¼äÉÏ·ÖÅäÄÚ´æ

         mov eax,0x00000000
         mov ebx,0x000fffff
         mov ecx,0x00c0b200                 ;4KBÁ£¶ÈµÄ¶ÑÕ»¶ÎÃèÊö·û£¬ÌØÈ¨¼¶1
         call flat_4gb_code_seg_sel:make_seg_descriptor
         mov ebx,esi                        ;TCBµÄ»ùµØÖ·
         call fill_descriptor_in_ldt
         or cx,0000_0000_0000_0001B         ;ÉèÖÃÑ¡Ôñ×ÓµÄÌØÈ¨¼¶Îª1

         mov ebx,[esi+0x14]                 ;´ÓTCBÖĞ»ñÈ¡TSSµÄÏßĞÔµØÖ·
         mov [ebx+16],cx                    ;ÌîĞ´TSSµÄSS1Óò
         mov edx,[esi+0x06]                 ;¶ÑÕ»µÄ¸ß¶ËÏßĞÔµØÖ·
         mov [ebx+12],edx                   ;ÌîĞ´TSSµÄESP1Óò 

         ;ÔÚÓÃ»§ÈÎÎñµÄ¾Ö²¿µØÖ·¿Õ¼äÄÚ´´½¨2ÌØÈ¨¼¶¶ÑÕ»
         alloc_user_linear                  ;ºê£ºÔÚÓÃ»§ÈÎÎñµØÖ·¿Õ¼äÉÏ·ÖÅäÄÚ´æ

         mov eax,0x00000000
         mov ebx,0x000fffff
         mov ecx,0x00c0d200                 ;4KBÁ£¶ÈµÄ¶ÑÕ»¶ÎÃèÊö·û£¬ÌØÈ¨¼¶2
         call flat_4gb_code_seg_sel:make_seg_descriptor
         mov ebx,esi                        ;TCBµÄ»ùµØÖ·
         call fill_descriptor_in_ldt
         or cx,0000_0000_0000_0010B         ;ÉèÖÃÑ¡Ôñ×ÓµÄÌØÈ¨¼¶Îª2

         mov ebx,[esi+0x14]                 ;´ÓTCBÖĞ»ñÈ¡TSSµÄÏßĞÔµØÖ·
         mov [ebx+24],cx                    ;ÌîĞ´TSSµÄSS2Óò
         mov edx,[esi+0x06]                 ;¶ÑÕ»µÄ¸ß¶ËÏßĞÔµØÖ·
         mov [ebx+20],edx                   ;ÌîĞ´TSSµÄESP2Óò 

         ;ÖØ¶¨Î»U-SALT 
         cld

         mov ecx,[0x0c]                     ;U-SALTÌõÄ¿Êı 
         mov edi,[0x08]                     ;U-SALTÔÚ4GB¿Õ¼äÄÚµÄÆ«ÒÆ 
  .b4:
         push ecx
         push edi
      
         mov ecx,salt_items
         mov esi,salt
  .b5:
         push edi
         push esi
         push ecx

         mov ecx,64                         ;¼ìË÷±íÖĞ£¬Ã¿ÌõÄ¿µÄ±È½Ï´ÎÊı 
         repe cmpsd                         ;Ã¿´Î±È½Ï4×Ö½Ú 
         jnz .b6
         mov eax,[esi]                      ;ÈôÆ¥Åä£¬ÔòesiÇ¡ºÃÖ¸ÏòÆäºóµÄµØÖ·
         mov [edi-256],eax                  ;½«×Ö·û´®¸ÄĞ´³ÉÆ«ÒÆµØÖ· 
         mov ax,[esi+4]
         or ax,0000000000000011B            ;ÒÔÓÃ»§³ÌĞò×Ô¼ºµÄÌØÈ¨¼¶Ê¹ÓÃµ÷ÓÃÃÅ
                                            ;¹ÊRPL=3 
         mov [edi-252],ax                   ;»ØÌîµ÷ÓÃÃÅÑ¡Ôñ×Ó 
  .b6:
      
         pop ecx
         pop esi
         add esi,salt_item_len
         pop edi                            ;´ÓÍ·±È½Ï 
         loop .b5
      
         pop edi
         add edi,256
         pop ecx
         loop .b4

         ;ÔÚGDTÖĞµÇ¼ÇLDTÃèÊö·û
         mov esi,[ebp+36]                   ;´Ó¶ÑÕ»ÖĞÈ¡µÃTCBµÄ»ùµØÖ·
         mov eax,[esi+0x0c]                 ;LDTµÄÆğÊ¼ÏßĞÔµØÖ·
         movzx ebx,word [esi+0x0a]          ;LDT¶Î½çÏŞ
         mov ecx,0x00408200                 ;LDTÃèÊö·û£¬ÌØÈ¨¼¶0
         call flat_4gb_code_seg_sel:make_seg_descriptor
         call flat_4gb_code_seg_sel:set_up_gdt_descriptor
         mov [esi+0x10],cx                  ;µÇ¼ÇLDTÑ¡Ôñ×Óµ½TCBÖĞ

         mov ebx,[esi+0x14]                 ;´ÓTCBÖĞ»ñÈ¡TSSµÄÏßĞÔµØÖ·
         mov [ebx+96],cx                    ;ÌîĞ´TSSµÄLDTÓò 

         mov word [ebx+0],0                 ;·´ÏòÁ´=0
      
         mov dx,[esi+0x12]                  ;¶Î³¤¶È£¨½çÏŞ£©
         mov [ebx+102],dx                   ;ÌîĞ´TSSµÄI/OÎ»Í¼Æ«ÒÆÓò 
      
         mov word [ebx+100],0               ;T=0
      
         mov eax,[0x04]                     ;´ÓÈÎÎñµÄ4GBµØÖ·¿Õ¼ä»ñÈ¡Èë¿Úµã 
         mov [ebx+32],eax                   ;ÌîĞ´TSSµÄEIPÓò 

         pushfd
         pop edx
         mov [ebx+36],edx                   ;ÌîĞ´TSSµÄEFLAGSÓò 

         ;ÔÚGDTÖĞµÇ¼ÇTSSÃèÊö·û
         mov eax,[esi+0x14]                 ;´ÓTCBÖĞ»ñÈ¡TSSµÄÆğÊ¼ÏßĞÔµØÖ·
         movzx ebx,word [esi+0x12]          ;¶Î³¤¶È£¨½çÏŞ£©
         mov ecx,0x00408900                 ;TSSÃèÊö·û£¬ÌØÈ¨¼¶0
         call flat_4gb_code_seg_sel:make_seg_descriptor
         call flat_4gb_code_seg_sel:set_up_gdt_descriptor
         mov [esi+0x18],cx                  ;µÇ¼ÇTSSÑ¡Ôñ×Óµ½TCB

         ;´´½¨ÓÃ»§ÈÎÎñµÄÒ³Ä¿Â¼
         ;×¢Òâ£¡Ò³µÄ·ÖÅäºÍÊ¹ÓÃÊÇÓÉÒ³Î»Í¼¾ö¶¨µÄ£¬¿ÉÒÔ²»Õ¼ÓÃÏßĞÔµØÖ·¿Õ¼ä 
         call flat_4gb_code_seg_sel:create_copy_cur_pdir
         mov ebx,[esi+0x14]                 ;´ÓTCBÖĞ»ñÈ¡TSSµÄÏßĞÔµØÖ·
         mov dword [ebx+28],eax             ;ÌîĞ´TSSµÄCR3(PDBR)Óò
                   
         popad
      
         ret 8                              ;¶ªÆúµ÷ÓÃ±¾¹ı³ÌÇ°Ñ¹ÈëµÄ²ÎÊı 
      
;-------------------------------------------------------------------------------
append_to_tcb_link:                         ;ÔÚTCBÁ´ÉÏ×·¼ÓÈÎÎñ¿ØÖÆ¿é
                                            ;ÊäÈë£ºECX=TCBÏßĞÔ»ùµØÖ·
         cli
         
         push eax
         push ebx

         mov eax,tcb_chain
  .b0:                                      ;EAX=Á´±íÍ·»òµ±Ç°TCBÏßĞÔµØÖ·
         mov ebx,[eax]                      ;EBX=ÏÂÒ»¸öTCBÏßĞÔµØÖ·
         or ebx,ebx
         jz .b1                             ;Á´±íÎª¿Õ£¬»òÒÑµ½Ä©Î²
         mov eax,ebx                        ;¶¨Î»µ½ÏÂÒ»¸öTCB£¨µÄÏßĞÔµØÖ·£©
         jmp .b0

  .b1:
         mov [eax],ecx
         mov dword [ecx],0x00000000         ;µ±Ç°TCBÖ¸ÕëÓòÇåÁã£¬ÒÔÖ¸Ê¾ÕâÊÇ×î
                                            ;ºóÒ»¸öTCB
         pop ebx
         pop eax
         
         sti
         
         ret
         
;-------------------------------------------------------------------------------
start:
         ;´´½¨ÖĞ¶ÏÃèÊö·û±íIDT
         ;ÔÚ´ËÖ®Ç°£¬½ûÖ¹µ÷ÓÃput_string¹ı³Ì£¬ÒÔ¼°ÈÎºÎº¬ÓĞstiÖ¸ÁîµÄ¹ı³Ì¡£
          
         ;Ç°20¸öÏòÁ¿ÊÇ´¦ÀíÆ÷Òì³£Ê¹ÓÃµÄ
         mov eax,general_exception_handler  ;ÃÅ´úÂëÔÚ¶ÎÄÚÆ«ÒÆµØÖ·
         mov bx,flat_4gb_code_seg_sel       ;ÃÅ´úÂëËùÔÚ¶ÎµÄÑ¡Ôñ×Ó
         mov cx,0x8e00                      ;32Î»ÖĞ¶ÏÃÅ£¬0ÌØÈ¨¼¶
         call flat_4gb_code_seg_sel:make_gate_descriptor

         mov ebx,idt_linear_address         ;ÖĞ¶ÏÃèÊö·û±íµÄÏßĞÔµØÖ·
         xor esi,esi
  .idt0:
         mov [ebx+esi*8],eax
         mov [ebx+esi*8+4],edx
         inc esi
         cmp esi,19                         ;°²×°Ç°20¸öÒì³£ÖĞ¶Ï´¦Àí¹ı³Ì
         jle .idt0

         ;ÆäÓàÎª±£Áô»òÓ²¼şÊ¹ÓÃµÄÖĞ¶ÏÏòÁ¿
         mov eax,general_interrupt_handler  ;ÃÅ´úÂëÔÚ¶ÎÄÚÆ«ÒÆµØÖ·
         mov bx,flat_4gb_code_seg_sel       ;ÃÅ´úÂëËùÔÚ¶ÎµÄÑ¡Ôñ×Ó
         mov cx,0x8e00                      ;32Î»ÖĞ¶ÏÃÅ£¬0ÌØÈ¨¼¶
         call flat_4gb_code_seg_sel:make_gate_descriptor

         mov ebx,idt_linear_address         ;ÖĞ¶ÏÃèÊö·û±íµÄÏßĞÔµØÖ·
  .idt1:
         mov [ebx+esi*8],eax
         mov [ebx+esi*8+4],edx
         inc esi
         cmp esi,255                        ;°²×°ÆÕÍ¨µÄÖĞ¶Ï´¦Àí¹ı³Ì
         jle .idt1

         ;ÉèÖÃÊµÊ±Ê±ÖÓÖĞ¶Ï´¦Àí¹ı³Ì
         mov eax,rtm_0x70_interrupt_handle  ;ÃÅ´úÂëÔÚ¶ÎÄÚÆ«ÒÆµØÖ·
         mov bx,flat_4gb_code_seg_sel       ;ÃÅ´úÂëËùÔÚ¶ÎµÄÑ¡Ôñ×Ó
         mov cx,0x8e00                      ;32Î»ÖĞ¶ÏÃÅ£¬0ÌØÈ¨¼¶
         call flat_4gb_code_seg_sel:make_gate_descriptor

         mov ebx,idt_linear_address         ;ÖĞ¶ÏÃèÊö·û±íµÄÏßĞÔµØÖ·
         mov [ebx+0x70*8],eax
         mov [ebx+0x70*8+4],edx

         ;×¼±¸¿ª·ÅÖĞ¶Ï
         mov word [pidt],256*8-1            ;IDTµÄ½çÏŞ
         mov dword [pidt+2],idt_linear_address
         lidt [pidt]                        ;¼ÓÔØÖĞ¶ÏÃèÊö·û±í¼Ä´æÆ÷IDTR

         ;ÉèÖÃ8259AÖĞ¶Ï¿ØÖÆÆ÷
         mov al,0x11
         out 0x20,al                        ;ICW1£º±ßÑØ´¥·¢/¼¶Áª·½Ê½
         mov al,0x20
         out 0x21,al                        ;ICW2:ÆğÊ¼ÖĞ¶ÏÏòÁ¿
         mov al,0x04
         out 0x21,al                        ;ICW3:´ÓÆ¬¼¶Áªµ½IR2
         mov al,0x01
         out 0x21,al                        ;ICW4:·Ç×ÜÏß»º³å£¬È«Ç¶Ì×£¬Õı³£EOI

         mov al,0x11
         out 0xa0,al                        ;ICW1£º±ßÑØ´¥·¢/¼¶Áª·½Ê½
         mov al,0x70
         out 0xa1,al                        ;ICW2:ÆğÊ¼ÖĞ¶ÏÏòÁ¿
         mov al,0x04
         out 0xa1,al                        ;ICW3:´ÓÆ¬¼¶Áªµ½IR2
         mov al,0x01
         out 0xa1,al                        ;ICW4:·Ç×ÜÏß»º³å£¬È«Ç¶Ì×£¬Õı³£EOI

         ;ÉèÖÃºÍÊ±ÖÓÖĞ¶ÏÏà¹ØµÄÓ²¼ş 
         mov al,0x0b                        ;RTC¼Ä´æÆ÷B
         or al,0x80                         ;×è¶ÏNMI
         out 0x70,al
         mov al,0x12                        ;ÉèÖÃ¼Ä´æÆ÷B£¬½ûÖ¹ÖÜÆÚĞÔÖĞ¶Ï£¬¿ª·Å¸ü
         out 0x71,al                        ;ĞÂ½áÊøºóÖĞ¶Ï£¬BCDÂë£¬24Ğ¡Ê±ÖÆ

         in al,0xa1                         ;¶Á8259´ÓÆ¬µÄIMR¼Ä´æÆ÷
         and al,0xfe                        ;Çå³ıbit 0(´ËÎ»Á¬½ÓRTC)
         out 0xa1,al                        ;Ğ´»Ø´Ë¼Ä´æÆ÷

         mov al,0x0c
         out 0x70,al
         in al,0x71                         ;¶ÁRTC¼Ä´æÆ÷C£¬¸´Î»Î´¾öµÄÖĞ¶Ï×´Ì¬

         sti                                ;¿ª·ÅÓ²¼şÖĞ¶Ï

       ;   mov ebx,message_0                     ;tag by me
       ;   call flat_4gb_code_seg_sel:put_string

         ;ÏÔÊ¾´¦ÀíÆ÷Æ·ÅÆĞÅÏ¢                     ; tag by me
       ;   mov eax,0x80000002
       ;   cpuid
       ;   mov [cpu_brand + 0x00],eax
       ;   mov [cpu_brand + 0x04],ebx
       ;   mov [cpu_brand + 0x08],ecx
       ;   mov [cpu_brand + 0x0c],edx
      
       ;   mov eax,0x80000003
       ;   cpuid
       ;   mov [cpu_brand + 0x10],eax
       ;   mov [cpu_brand + 0x14],ebx
       ;   mov [cpu_brand + 0x18],ecx
       ;   mov [cpu_brand + 0x1c],edx

       ;   mov eax,0x80000004
       ;   cpuid
       ;   mov [cpu_brand + 0x20],eax
       ;   mov [cpu_brand + 0x24],ebx
       ;   mov [cpu_brand + 0x28],ecx
       ;   mov [cpu_brand + 0x2c],edx

       ;   mov ebx,cpu_brnd0                  ;ÏÔÊ¾´¦ÀíÆ÷Æ·ÅÆĞÅÏ¢ 
       ;   call flat_4gb_code_seg_sel:put_string
       ;   mov ebx,cpu_brand
       ;   call flat_4gb_code_seg_sel:put_string
       ;   mov ebx,cpu_brnd1
       ;   call flat_4gb_code_seg_sel:put_string

         ;ÒÔÏÂ¿ªÊ¼°²×°ÎªÕû¸öÏµÍ³·şÎñµÄµ÷ÓÃÃÅ¡£ÌØÈ¨¼¶Ö®¼äµÄ¿ØÖÆ×ªÒÆ±ØĞëÊ¹ÓÃÃÅ
         mov edi,salt                       ;C-SALT±íµÄÆğÊ¼Î»ÖÃ 
         mov ecx,salt_items                 ;C-SALT±íµÄÌõÄ¿ÊıÁ¿ 
  .b4:
         push ecx   
         mov eax,[edi+256]                  ;¸ÃÌõÄ¿Èë¿ÚµãµÄ32Î»Æ«ÒÆµØÖ· 
         mov bx,[edi+260]                   ;¸ÃÌõÄ¿Èë¿ÚµãµÄ¶ÎÑ¡Ôñ×Ó 
         mov cx,1_11_0_1100_000_00000B      ;ÌØÈ¨¼¶3µÄµ÷ÓÃÃÅ(3ÒÔÉÏµÄÌØÈ¨¼¶²Å
                                            ;ÔÊĞí·ÃÎÊ)£¬0¸ö²ÎÊı(ÒòÎªÓÃ¼Ä´æÆ÷
                                            ;´«µİ²ÎÊı£¬¶øÃ»ÓĞÓÃÕ») 
         call flat_4gb_code_seg_sel:make_gate_descriptor
         call flat_4gb_code_seg_sel:set_up_gdt_descriptor
         mov [edi+260],cx                   ;½«·µ»ØµÄÃÅÃèÊö·ûÑ¡Ôñ×Ó»ØÌî
         add edi,salt_item_len              ;Ö¸ÏòÏÂÒ»¸öC-SALTÌõÄ¿ 
         pop ecx
         loop .b4

         ;¶ÔÃÅ½øĞĞ²âÊÔ 
       ;   mov ebx,message_1                     ; tag by me
       ;   call far [salt_1+256]              ;Í¨¹ıÃÅÏÔÊ¾ĞÅÏ¢(Æ«ÒÆÁ¿½«±»ºöÂÔ) 

         ;³õÊ¼»¯´´½¨³ÌĞò¹ÜÀíÆ÷ÈÎÎñµÄÈÎÎñ¿ØÖÆ¿éTCB
         mov word [core_tcb+0x04],0xffff    ;ÈÎÎñ×´Ì¬£ºÃ¦Âµ
         mov dword [core_tcb+0x06],0x80100000    
                                            ;ÄÚºËĞéÄâ¿Õ¼äµÄ·ÖÅä´ÓÕâÀï¿ªÊ¼¡£
         mov word [core_tcb+0x0a],0xffff    ;µÇ¼ÇLDT³õÊ¼µÄ½çÏŞµ½TCBÖĞ£¨Î´Ê¹ÓÃ£©
         mov ecx,core_tcb
         call append_to_tcb_link            ;½«´ËTCBÌí¼Óµ½TCBÁ´ÖĞ

         ;Îª³ÌĞò¹ÜÀíÆ÷µÄTSS·ÖÅäÄÚ´æ¿Õ¼ä
         alloc_core_linear                  ;ºê£ºÔÚÄÚºËµÄĞéÄâµØÖ·¿Õ¼ä·ÖÅäÄÚ´æ

         ;ÔÚ³ÌĞò¹ÜÀíÆ÷µÄTSSÖĞÉèÖÃ±ØÒªµÄÏîÄ¿ 
         mov word [ebx+0],0                 ;·´ÏòÁ´=0
         mov eax,cr3
         mov dword [ebx+28],eax             ;µÇ¼ÇCR3(PDBR)
         mov word [ebx+96],0                ;Ã»ÓĞLDT¡£´¦ÀíÆ÷ÔÊĞíÃ»ÓĞLDTµÄÈÎÎñ¡£
         mov word [ebx+100],0               ;T=0
         mov word [ebx+102],103             ;Ã»ÓĞI/OÎ»Í¼¡£0ÌØÈ¨¼¶ÊÂÊµÉÏ²»ĞèÒª¡£
         
         ;´´½¨³ÌĞò¹ÜÀíÆ÷µÄTSSÃèÊö·û£¬²¢°²×°µ½GDTÖĞ 
         mov eax,ebx                        ;TSSµÄÆğÊ¼ÏßĞÔµØÖ·
         mov ebx,103                        ;¶Î³¤¶È£¨½çÏŞ£©
         mov ecx,0x00408900                 ;TSSÃèÊö·û£¬ÌØÈ¨¼¶0
         call flat_4gb_code_seg_sel:make_seg_descriptor
         call flat_4gb_code_seg_sel:set_up_gdt_descriptor
         mov [core_tcb+0x18],cx             ;µÇ¼ÇÄÚºËÈÎÎñµÄTSSÑ¡Ôñ×Óµ½ÆäTCB

         ;ÈÎÎñ¼Ä´æÆ÷TRÖĞµÄÄÚÈİÊÇÈÎÎñ´æÔÚµÄ±êÖ¾£¬¸ÃÄÚÈİÒ²¾ö¶¨ÁËµ±Ç°ÈÎÎñÊÇË­¡£
         ;ÏÂÃæµÄÖ¸ÁîÎªµ±Ç°ÕıÔÚÖ´ĞĞµÄ0ÌØÈ¨¼¶ÈÎÎñ¡°³ÌĞò¹ÜÀíÆ÷¡±ºó²¹ÊÖĞø£¨TSS£©¡£
         ltr cx

         ;ÏÖÔÚ¿ÉÈÏÎª¡°³ÌĞò¹ÜÀíÆ÷¡±ÈÎÎñÕıÖ´ĞĞÖĞ

         ;´´½¨ÓÃ»§ÈÎÎñµÄÈÎÎñ¿ØÖÆ¿é 
         alloc_core_linear                  ;ºê£ºÔÚÄÚºËµÄĞéÄâµØÖ·¿Õ¼ä·ÖÅäÄÚ´æ
         
         mov word [ebx+0x04],0              ;ÈÎÎñ×´Ì¬£º¿ÕÏĞ 
         mov dword [ebx+0x06],0             ;ÓÃ»§ÈÎÎñ¾Ö²¿¿Õ¼äµÄ·ÖÅä´Ó0¿ªÊ¼¡£
         mov word [ebx+0x0a],0xffff         ;µÇ¼ÇLDT³õÊ¼µÄ½çÏŞµ½TCBÖĞ
      
         push dword 50                      ;ÓÃ»§³ÌĞòÎ»ÓÚÂß¼­50ÉÈÇø
         push ebx                           ;Ñ¹ÈëÈÎÎñ¿ØÖÆ¿éÆğÊ¼ÏßĞÔµØÖ· 
         call load_relocate_program
         mov ecx,ebx         
         call append_to_tcb_link            ;½«´ËTCBÌí¼Óµ½TCBÁ´ÖĞ

         ;´´½¨ÓÃ»§ÈÎÎñµÄÈÎÎñ¿ØÖÆ¿é
         alloc_core_linear                  ;ºê£ºÔÚÄÚºËµÄĞéÄâµØÖ·¿Õ¼ä·ÖÅäÄÚ´æ

         mov word [ebx+0x04],0              ;ÈÎÎñ×´Ì¬£º¿ÕÏĞ
         mov dword [ebx+0x06],0             ;ÓÃ»§ÈÎÎñ¾Ö²¿¿Õ¼äµÄ·ÖÅä´Ó0¿ªÊ¼¡£
         mov word [ebx+0x0a],0xffff         ;µÇ¼ÇLDT³õÊ¼µÄ½çÏŞµ½TCBÖĞ

         push dword 100                     ;ÓÃ»§³ÌĞòÎ»ÓÚÂß¼­100ÉÈÇø
         push ebx                           ;Ñ¹ÈëÈÎÎñ¿ØÖÆ¿éÆğÊ¼ÏßĞÔµØÖ·
         call load_relocate_program
         mov ecx,ebx
         call append_to_tcb_link            ;½«´ËTCBÌí¼Óµ½TCBÁ´ÖĞ

  .core:
       ;   mov ebx,core_msg0                     ;tag by me
       ;   call flat_4gb_code_seg_sel:put_string
         
         ;ÕâÀï¿ÉÒÔ±àĞ´»ØÊÕÒÑÖÕÖ¹ÈÎÎñÄÚ´æµÄ´úÂë
          
         jmp .core
            
core_code_end:

;-------------------------------------------------------------------------------
SECTION core_trail
;-------------------------------------------------------------------------------
core_end: